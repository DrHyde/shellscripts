#!/usr/bin/env bash

# -j to report in JSON
# -r RATE to check if the rate of the given file matches RATE

if [ "$1" == "-j" ]; then
    shift
    $0 "$@" | jq -Rn '
        [inputs
        | capture("(?<fps>\\d+(\\.\\d+)?)(: (?<file>.*))?")
        | {file: .file // "'"$1"'", fps: (.fps | tonumber)}] | if length == 1 then .[0] else . end
    '
    exit $?
elif [ "$1" == "-r" ]; then
    shift
    RATEWANTED=$1
    shift

    if [ $# -ne 1 ]; then
        echo "Error: -r requires exactly one file" >&2
        exit 2
    fi
    if [ "$($0 "$1")" == "$RATEWANTED" ]; then
        exit 0
    else
        exit 1
    fi
fi

for file in "$@"; do
    (
        echo -n $(ffmpeg -i "$file" 2>&1 | sed -n "s/.*, \(.*\) fp.*/\1/p") && (
            if [ $# -ne 1 ]; then
                echo -n : $file
            fi
        ) &&
        echo
    ) || echo 0
done
